const $=(id)=>document.getElementById(id);const num=(v)=>{const n=Number(v);return isFinite(n)?n:0};const fmt=(v)=>(v===null||v===undefined||Number.isNaN(v))?"–":String(Math.round((v+Number.EPSILON)*100)/100);function showMsg(t,o=!0){const e=$("msg");e.style.color=o?"#7be495":"#ff9e9e",e.textContent=t,setTimeout(()=>e.textContent="",3e3)}let pendingPhoto=null,acceptedPhoto=null;const cameraInput=$("cameraInput"),photoPreview=$("photoPreview");cameraInput.addEventListener("change",(e)=>{const t=e.target.files?.[0];if(!t)return;const o=new FileReader;o.onload=()=>{pendingPhoto=o.result,renderPhotoPreview(pendingPhoto),$("acceptPhoto").disabled=!1,$("discardPhoto").disabled=!1},o.readAsDataURL(t)}),$("acceptPhoto").addEventListener("click",()=>{pendingPhoto&&(acceptedPhoto=pendingPhoto,showMsg("Foto übernommen."))}),$("discardPhoto").addEventListener("click",()=>{pendingPhoto=null,acceptedPhoto=null,cameraInput.value="",renderPhotoPreview(null),$("acceptPhoto").disabled=!0,$("discardPhoto").disabled=!0});function renderPhotoPreview(e){photoPreview.innerHTML=e?`<img src="${e}" alt="Foto">`:"Kein Foto"}function createImage(e){return new Promise((t,o)=>{const n=new Image;n.onload=()=>t(n),n.onerror=o,n.src=e})}function dataURLSizeKB(e){const t=e.split(",")[1]||"";return Math.ceil(3*t.length/4/1024)}async function resizeAndCompress(e,t=100){const o=await createImage(e),n=document.createElement("canvas");n.width=151,n.height=151;const r=n.getContext("2d");r.drawImage(o,0,0,151,151);let a=.92,i=n.toDataURL("image/jpeg",a);for(let e=0;e<8&&dataURLSizeKB(i)>t&&a>.4;e++)a-=.08,i=n.toDataURL("image/jpeg",a);return i}function getDefaults(){return{L:num($("defL").value),R:num($("defR").value),O:num($("defO").value),U:num($("defU").value),N:num($("defN").value)}}function seedAdjustFromDefaults(){const e=getDefaults();$("ovL").value=String(e.L),$("ovR").value=String(e.R),$("ovO").value=String(e.O),$("ovU").value=String(e.U),$("ovN").value=String(e.N),$("hintL").textContent=`Standard: ${e.L} mm`,$("hintR").textContent=`Standard: ${e.R} mm`,$("hintO").textContent=`Standard: ${e.O} mm`,$("hintU").textContent=`Standard: ${e.U} mm`,$("hintN").textContent=`Standard: ${e.N} mm`}function getAdjust(){return{L:num($("ovL").value),R:num($("ovR").value),O:num($("ovO").value),U:num($("ovU").value),N:num($("ovN").value)}}const inputIds=["inFLBreite","inFLHoehe","inUKFutter","inUKOK","inRahmenbreite","inEingabeL","inEingabeR","ovL","ovR","ovO","ovU","ovN","defL","defR","defO","defU","defN","bauposition"];inputIds.forEach(e=>{const t=$(e);t&&t.addEventListener("input",refreshCalcs)});function refreshCalcs(){const e=num($("inFLBreite").value),t=num($("inFLHoehe").value),o=num($("inUKFutter").value),n=num($("inUKOK").value),r=num($("inRahmenbreite").value);let a=""===$("inEingabeL").value?null:num($("inEingabeL").value),i=""===$("inEingabeR").value?null:num($("inEingabeR").value);const l=getAdjust();null!==a&&null===i?i=r-e-a:null!==i&&null===a&&(a=r-e-i),$("autoEingR").textContent=null===i?"–":fmt(i),$("autoEingL").textContent=null===a?"–":fmt(a);const u=r-e-(null!=i?i:0)+l.L,d=r-e-(null!=a?a:0)+l.R,s=o-t+l.U,c=n-o+l.O,m=Math.max(0,s-l.N),g=e-l.L-l.R,v=t-l.O-l.U,h=g+u+d,p=v+c+s;return $("rbL").textContent=fmt(u),$("rbR").textContent=fmt(d),$("rbU").textContent=fmt(c),$("rbO").textContent=fmt(s),$("ueberO").textContent=fmt(m),$("rlB").textContent=fmt(g),$("rlH").textContent=fmt(v),$("raB").textContent=fmt(h),$("raH").textContent=fmt(p),$("pairRbL").textContent=fmt(u),$("pairRbR").textContent=fmt(d),$("pairRbU").textContent=fmt(c),$("pairRbO").textContent=fmt(s),$("pairUeberO").textContent=fmt(m),{FLB:e,FLH:t,UKF:o,UKOK:n,RB:r,EingL:a,EingR:i,RbL:u,RbR:d,RbU:c,RbO:s,UeberO:m,RlB:g,RlH:v,RaB:h,RaH:p}}seedAdjustFromDefaults(),refreshCalcs();let nextId=1,position=1;const records=[];$("saveRow").addEventListener("click",async()=>{const e=$("inFLBreite").value.trim(),t=$("inFLHoehe").value.trim(),o=$("inUKFutter").value.trim(),n=$("inUKOK").value.trim(),r=$("inRahmenbreite").value.trim();if(!e||!t||!o||!n||!r)return void showMsg("Bitte alle 5 Hauptwerte eingeben.",!1);const a=refreshCalcs();let i=null;acceptedPhoto&&(i=await resizeAndCompress(acceptedPhoto,100));const l={id:nextId++,position:position,bauposition:$("bauposition").value.trim(),bemerkung:$("bemerkung").value.trim(),photoDataUrl:i,defaults:getDefaults(),overrides:getAdjust(),inputs:{FLB:a.FLB,FLH:a.FLH,UKF:a.UKF,UKOK:a.UKOK,RB:a.RB,EingL:a.EingL,EingR:a.EingR},results:{RbL:a.RbL,RbR:a.RbR,RbU:a.RbU,RbO:a.RbO,UeberO:a.UeberO,RlB:a.RlB,RlH:a.RlH,RaB:a.RaB,RaH:a.RaH}};records.push(l),position++,$("posLabel").textContent=String(position),acceptedPhoto=null,pendingPhoto=null,cameraInput.value="",renderPhotoPreview(null),["inFLBreite","inFLHoehe","inUKFutter","inUKOK","inRahmenbreite","inEingabeL","inEingabeR","bemerkung","bauposition"].forEach(e=>$(e).value=""),seedAdjustFromDefaults(),refreshCalcs(),renderList(),showMsg("Position gespeichert.")});function renderList(){const e=$("list");if(0===records.length)return void(e.innerHTML="<i>Keine Positionen erfasst.</i>");e.innerHTML=records.map(e=>{const t=e.results,o=e.photoDataUrl?`<img src="${e.photoDataUrl}" alt="Foto">`:'<div class="placeholder">kein Foto</div>',n=e.bauposition?` – <i>${e.bauposition}</i>`:"";return`<div class="rowCard">
      ${o}
      <div class="rowMeta">
        <div><b>Pos. ${e.position}</b>${n} – ${e.bemerkung||""}</div>
        <div>RL (B×H): ${fmt(t.RlB)} × ${fmt(t.RlH)}</div>
        <div>RA (B×H): ${fmt(t.RaB)} × ${fmt(t.RaH)}</div>
        <div>Links ${fmt(t.RbL)} | Rechts ${fmt(t.RbR)} | Unten ${fmt(t.RbU)} | Oben ${fmt(t.RbO)} (Rahmenverbreiterung ${fmt(t.UeberO)})</div>
      </div>
      <div class="rowActions"><button class="primary" onclick="openEdit(${e.id})">Bearbeiten</button></div>
    </div>`}).join("")}const editDialog=$("editDialog"),editPhotoInput=$("editPhotoInput");let editingId=null;window.openEdit=e=>{const t=records.find(t=>t.id===e);t&&(editingId=e,$("editPreview").innerHTML=t.photoDataUrl?`<img src="${t.photoDataUrl}" alt="Foto">`:"Kein Foto",$("eBau").value=t.bauposition||"",$("eFLB").value=t.inputs.FLB,$("eFLH").value=t.inputs.FLH,$("eUKF").value=t.inputs.UKF,$("eUKOK").value=t.inputs.UKOK,$("eRB").value=t.inputs.RB,$("eEL").value=null!=t.inputs.EingL?t.inputs.EingL:"",$("eER").value=null!=t.inputs.EingR?t.inputs.EingR:"",$("eL").value=t.overrides.L,$("eR").value=t.overrides.R,$("eO").value=t.overrides.O,$("eU").value=t.overrides.U,$("eN").value=t.overrides.N,$("eBem").value=t.bemerkung||"",editDialog.showModal())},editPhotoInput.addEventListener("change",e=>{const t=e.target.files?.[0];if(!t)return;const o=new FileReader;o.onload=()=>{$("editPreview").innerHTML=`<img src="${o.result}">`,$("editPreview").dataset.new=o.result},o.readAsDataURL(t)}),$("deleteBtn").addEventListener("click",()=>{if(null==editingId)return;const e=records.findIndex(e=>e.id===editingId);e>=0&&records.splice(e,1),editDialog.close(),renderList(),showMsg("Position gelöscht.")}),$("saveEditBtn").addEventListener("click",async e=>{if(e.preventDefault(),null==editingId)return;const t=records.find(e=>e.id===editingId);if(!t)return;t.bauposition=$("eBau").value.trim(),t.inputs.FLB=num($("eFLB").value),t.inputs.FLH=num($("eFLH").value),t.inputs.UKF=num($("eUKF").value),t.inputs.UKOK=num($("eUKOK").value),t.inputs.RB=num($("eRB").value);let o=$("eEL").value.trim(),n=$("eER").value.trim(),r=""===o?null:num(o),a=""===n?null:num(n);null!==r&&null===a?a=t.inputs.RB-t.inputs.FLB-r:null!==a&&null===r&&(r=t.inputs.RB-t.inputs.FLB-a),t.inputs.EingL=r,t.inputs.EingR=a,t.overrides={L:num($("eL").value),R:num($("eR").value),O:num($("eO").value),U:num($("eU").value),N:num($("eN").value)},t.bemerkung=$("eBem").value.trim();const i=t.overrides,l=t.inputs.RB-t.inputs.FLB-(null!=t.inputs.EingR?t.inputs.EingR:0)+i.L,u=t.inputs.RB-t.inputs.FLB-(null!=t.inputs.EingL?t.inputs.EingL:0)+i.R,d=t.inputs.UKF-t.inputs.FLH+i.U,s=t.inputs.UKOK-t.inputs.UKF+i.O,c=Math.max(0,s-i.N),m=t.inputs.FLB-i.L-i.R,g=t.inputs.FLH-i.O-i.U,v=m+l+u,h=g+d+s;t.results={RbL:l,RbR:u,RbU:d,RbO:s,UeberO:c,RlB:m,RlH:g,RaB:v,RaH:h};const p=$("editPreview").dataset.new;p&&(t.photoDataUrl=await resizeAndCompress(p,100),delete $("editPreview").dataset.new),editDialog.close(),renderList(),showMsg("Änderungen gespeichert.")});$("exportBtn").addEventListener("click",async()=>{if(0===records.length)return void showMsg("Keine Daten zum Export.",!1);try{const e=new ExcelJS.Workbook,t=e.addWorksheet("Fenster"),o=["Position","Foto","Bauposition","Hinweise/Speziell","FL Breite","FL Höhe","UKR-Futter","UKR-OK","Rahmenbreite","Eingabe L","Eingabe R","Einstand L","Einstand R","Einstand O","Einstand U","Normrahmen","Rb links","Rb rechts","Rb unten","Rb oben","(Rahmenverbreiterung)","RL Breite","RL Höhe","RA Breite","RA Höhe"];t.addRow(o),t.getRow(1).font={bold:!0,color:{argb:"FFFFFFFF"}},t.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF1b84e8"}},t.columns=[{width:10},{width:26},{width:18},{width:24},{width:12},{width:12},{width:14},{width:14},{width:14},{width:12},{width:12},{width:12},{width:12},{width:12},{width:12},{width:14},{width:14},{width:14},{width:14},{width:14},{width:18},{width:14},{width:14},{width:14},{width:14}];const n=[...records].sort((e,t)=>e.position-t.position);for(let r=0;r<n.length;r++){const a=n[r],i=r+2;t.addRow([a.position,"",a.bauposition||"",a.bemerkung||"",a.inputs.FLB,a.inputs.FLH,a.inputs.UKF,a.inputs.UKOK,a.inputs.RB,a.inputs.EingL,a.inputs.EingR,a.overrides.L,a.overrides.R,a.overrides.O,a.overrides.U,a.overrides.N,a.results.RbL,a.results.RbR,a.results.RbU,a.results.RbO,a.results.UeberO,a.results.RlB,a.results.RlH,a.results.RaB,a.results.RaH]),t.getRow(i).height=115,a.photoDataUrl&&(()=>{const[e,o]=a.photoDataUrl.split(","),n=e.includes("image/png"),r=t.workbook.addImage({base64:o,extension:n?"png":"jpeg"});t.addImage(r,{tl:{col:1,row:i-1},ext:{width:151,height:151},editAs:"oneCell"})})()}const r=await e.xlsx.writeBuffer(),a=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});saveAs(a,"fenster_erfassung_v3_3.xlsx");if($("csvToggle").checked){const e=[];e.push(o.map(e=>`"${e}"`).join(";"));for(const t of n){const o=[t.position,"",t.bauposition||"",t.bemerkung||"",t.inputs.FLB,t.inputs.FLH,t.inputs.UKF,t.inputs.UKOK,t.inputs.RB,t.inputs.EingL??"",t.inputs.EingR??"",t.overrides.L,t.overrides.R,t.overrides.O,t.overrides.U,t.overrides.N,t.results.RbL,t.results.RbR,t.results.RbU,t.results.RbO,t.results.UeberO,t.results.RlB,t.results.RlH,t.results.RaB,t.results.RaH];e.push(o.join(";"))}const t=new Blob([e.join("\n")],{type:"text/csv;charset=utf-8"});saveAs(t,"fenster_erfassung_v3_3.csv")}}catch(e){console.error(e),showMsg("Export-Fehler: "+e.message,!1)}});